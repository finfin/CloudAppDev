/*! MessageBoard 28-06-2013 */
var apn=require("../util/apnhandler"),mongoose=require("mongoose"),User=mongoose.model("User"),Message=mongoose.model("Message"),log4js=require("log4js"),logger=log4js.getLogger();exports.index=function(a,b){var c=10,d={$or:[{type:"public"}]};a.user&&(d.$or.push({user:a.user.name}),d.$or.push({target:a.user.name})),a.query.name&&(d.user=a.query.name),Message.find(d).limit(c).skip(c*(a.query.page-1)).exec(function(c,d){return c?(logger.error(c),b.send(500,"error"),void 0):(b.render("index",{title:"Message Board",messages:d||[],user:a.user}),void 0)})},exports.list=function(a,b){console.log("list shown");var c={$or:[{type:"public"}]};a.user&&(c.$or.push({user:a.user.name}),c.$or.push({target:a.user.name})),a.query.name&&(c.user=a.query.name),Message.find(c).exec(function(a,c){return a?(logger.error(a),b.send(500,"error"),void 0):(b.send(c),void 0)})},exports.myMessage=function(a,b){var c=10;Message.find({$or:[{user:a.user.name},{target:a.user.name}]}).limit(c).skip(c*(a.query.page-1)).exec(function(c,d){return c?(logger.error(c),b.send(500,"error"),void 0):(b.render("index",{title:"My Message Board",messages:d||[],user:a.user}),void 0)})},exports.myMessageAPI=function(a,b){var c=10;Message.find({$or:[{user:a.user.name},{target:a.user.name}]}).limit(c).skip(c*(a.query.page-1)).exec(function(a,c){return a?(logger.error(a),b.send(500,"error"),void 0):(b.send(c),void 0)})},exports.createMessage=function(a,b){Message.create({user:a.user.name,text:a.body.text,type:a.body.type,target:a.body.target},function(c,d){return c?(logger.error(c),b.send(500,"Message creation error"),void 0):("private"===d.type?User.findOne({name:d.target},function(c,e){return c||!e?(logger.error(c),b.send(500,"error"),void 0):(e.UUID&&apn.notification(e.UUID,d.text),b.redirect(a.get("Referrer")),void 0)}):b.redirect(a.get("Referrer")),void 0)})},exports.removeMessage=function(a,b){var c={_id:a.params.id};a.user&&!a.user.admin&&(c.user=a.user.name),console.log(c),Message.remove(c,function(c,d){return c||!d?(console.log(c),b.send(500,"Cant remove such message"),void 0):(b.redirect(a.get("Referrer")),void 0)})};