/*! MessageBoard 28-06-2013 */
var mongoose=require("mongoose"),passport=require("passport"),Mailer=require("../util/emailer"),User=mongoose.model("User"),log4js=require("log4js"),logger=log4js.getLogger();exports.loginView=function(a,b){b.render("login",{title:"Message Board",message:a.session.messages})},exports.registerView=function(a,b){b.render("register",{title:"註冊使用者"})},exports.login=function(a,b,c){passport.authenticate("local",function(d,e,f){return d?c(d):e?a.logIn(e,function(d){return d?c(d):(e.UUID=a.body.UUID,e.save(function(a){a&&logger.error(a),b.redirect("/")}),void 0)}):(a.session.messages=[f.message],b.redirect("/login"))})(a,b,c)},exports.apiLogin=function(a,b,c){passport.authenticate("local",function(d,e){return d?c(d):e?(b.cookie("apikey",e.apikey,{maxAge:86409e3,httpOnly:!0}),e.UUID=a.body.UUID,e.save(function(a){a&&logger.error(a),b.end()}),void 0):b.send(403)})(a,b,c)},exports.apiLogout=function(a,b){return b.clearCookie("apikey"),b.end()},exports.list=function(a,b){User.find({},function(c,d){return c?(logger.error(c),b.send(500,"error"),void 0):(b.render("user/list",{users:d,user:a.user}),void 0)})},exports.detail=function(a,b){User.findOne({name:a.params.name},function(a,c){return a?(logger.error(a),b.send(500),void 0):c?(b.send(c),void 0):(b.send(400,"cannot find users with this id"),void 0)})},exports.remove=function(a,b){User.findOneAndRemove({name:a.params.name},function(a,c){return a?(logger.error(a),b.send(500),void 0):c?(b.send("User: "+c.name+" removed"),void 0):(b.send(400,"cannot find users with this id"),void 0)})},exports.logout=function(a,b){a.logout(),b.redirect("/")},exports.register=function(a,b){User.create({name:a.body.name,email:a.body.email,password:a.body.password,description:a.body.description,admin:Boolean(a.body.admin)},function(c,d){if(c)return logger.error(c),b.send(400,"Invalid data format or duplicate user name"),void 0;console.log("Created user:",d.name),b.send("successfully created user:"+d.name);var e={to:d.email},f={name:d.name,token:d.token,host:a.headers.host},g=new Mailer(e,f);g.send(function(a){return a?logger.error(a):void 0})})},exports.editView=function(a,b){User.findOne({name:a.params.name},function(c,d){return c?(logger.error(c),b.send(500),void 0):d?(b.render("user/edit",{editUser:d,user:a.user}),void 0):(b.send(400,"cannot find users with this id"),void 0)})},exports.edit=function(a,b){User.findOneAndUpdate({name:a.params.name},{email:a.body.email,description:a.body.description},function(a,c){return a?(logger.error(a),b.send(500),void 0):c?(b.redirect("/users"),void 0):(b.send(400,"cannot find users with this id"),void 0)})},exports.validate=function(a,b){var c=a.query.token;return User.findOneAndUpdate({token:c},{enabled:!0,token:null},function(c,d){return c?b.send(500):d?(a.session.messages=["User: "+d.name+" validated, please login."],b.redirect("/login")):b.send(403)})};